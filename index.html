<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Facecard</title>
  <meta name="description" content="Submit your facecard. Vote your favorites. Hall of Fame top 10." />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b0b0f; --card:#15151c; --text:#e9e9ef; --muted:#a3a3ad; --accent:#8b5cf6; --good:#22c55e; --bad:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:#0b0b0f;color:var(--text);font:16px/1.55 Inter, ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:10;background:rgba(11,11,15,.9);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid #20202a}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:center}
    .brand{font-weight:800;letter-spacing:.5px;color:var(--accent);font-size:20px}
    .nav a{color:var(--muted);text-decoration:none;margin-right:14px}
    .nav a.active{color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:16px;margin-top:20px}
    .card{background:var(--card);border:1px solid #23232f;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;transition:transform .12s ease, box-shadow .12s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.25)}
    .card img{width:100%;aspect-ratio:1/1;object-fit:cover}
    .card .meta{padding:10px}
    .vote{display:flex;gap:6px;justify-content:center;padding:8px;border-top:1px solid #1e1e28}
    .btn{flex:1;padding:8px 0;border:none;cursor:pointer;font-weight:600;color:#fff;border-radius:0}
    .btn.up{background:var(--good)}
    .btn.down{background:var(--bad)}
    .btn:hover{opacity:.9}
    .upload-form{background:var(--card);padding:20px;border-radius:16px;max-width:480px;margin:40px auto}
    .upload-form h2{margin-top:0}
    .upload-form input{width:100%;padding:12px;margin:6px 0;border-radius:12px;border:1px solid #2a2a36;background:#101018;color:var(--text)}
    .upload-form button{width:100%;padding:12px;margin-top:10px;background:var(--accent);border:none;border-radius:12px;color:#fff;font-weight:700;cursor:pointer}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js" defer></script>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="brand">üí≥ Facecard</div>
      <nav class="nav">
        <a href="#/browse" id="nav-browse">Browse</a>
        <a href="#/submit" id="nav-submit">Submit</a>
        <a href="#/hall" id="nav-hall">Hall of Fame</a>
      </nav>
      <div style="margin-left:auto" class="search">
        <input id="searchInput" type="search" placeholder="Search username or @handle‚Ä¶" />
      </div>
    </div>
  </header>

  <main class="wrap" id="app"></main>

  <footer>
    Built for the TikTok "Facecard" trend ‚Ä¢ One vote/person per submission via edge IP hash ‚Ä¢ Host: GitHub Pages
  </footer>

  <script>
  const SUPABASE_URL = "https://sfxmpqgxvuvnwwuesmin.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const EDGE_FUNCTION_URL = "https://sfxmpqgxvuvnwwuesmin.supabase.co/functions/v1/cast-vote";

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  function route(){
    const hash = location.hash || '#/browse';
    document.querySelectorAll('.nav a').forEach(a => a.classList.remove('active'));
    if (hash.startsWith('#/browse')) {document.getElementById('nav-browse').classList.add('active');renderBrowse();}
    if (hash.startsWith('#/submit')) {document.getElementById('nav-submit').classList.add('active');renderSubmit();}
    if (hash.startsWith('#/hall')) {document.getElementById('nav-hall').classList.add('active');renderHall();}
  }
  window.addEventListener('hashchange',route);
  window.addEventListener('load',route);

  async function renderBrowse(){
    const el=document.getElementById('app');
    el.innerHTML=`<h2>Browse Facecards</h2><div class="grid" id="grid"></div>`;
    const {data,error}=await supabase.from('v_submissions_with_score').select('*').order('created_at',{ascending:false}).limit(60);
    if(error){document.getElementById('grid').innerHTML='<p>Error loading</p>';return;}
    renderCards(data);
  }

  async function renderHall(){
    const el=document.getElementById('app');
    el.innerHTML=`<h2>üèÜ Hall of Fame</h2><div class="grid" id="grid"></div>`;
    const {data,error}=await supabase.from('v_submissions_with_score').select('*').order('score',{ascending:false}).limit(10);
    if(error){document.getElementById('grid').innerHTML='<p>Error</p>';return;}
    renderCards(data,true);
  }

  function renderCards(rows,showRank=false){
    const grid=document.getElementById('grid');
    grid.innerHTML=rows.map((r,idx)=>{
      return `<div class="card">
        <img src="${r.image_url}" alt="${r.display_name}" />
        <div class="meta">
          <strong>${r.display_name}</strong><br>
          ${r.x_handle?`<span>@${r.x_handle}</span>`:''}
          ${showRank?`<div>#${idx+1} Score:${r.score}</div>`:`<div>Score:${r.score}</div>`}
        </div>
        <div class="vote">
          <button class="btn up" onclick="vote('${r.id}',1)">üëç</button>
          <button class="btn down" onclick="vote('${r.id}',-1)">üëé</button>
        </div>
      </div>`;
    }).join('');
  }

  async function renderSubmit(){
    const el=document.getElementById('app');
    el.innerHTML=`<div class="upload-form">
      <h2>Submit Your Facecard</h2>
      <input id="displayName" placeholder="Display Name" required>
      <input id="imageUrl" placeholder="Image URL (or upload below)">
      <input type="file" id="imageFile" accept="image/*">
      <input id="xHandle" placeholder="X handle (optional)">
      <input id="verifyUrl" placeholder="Verification tweet URL (optional)">
      <button onclick="submitCard()">Submit</button>
    </div>`;
  }

  async function submitCard(){
    const name=document.getElementById('displayName').value.trim();
    const urlInput=document.getElementById('imageUrl').value.trim();
    const file=document.getElementById('imageFile').files[0];
    const xHandle=document.getElementById('xHandle').value.trim()||null;
    const verifyUrl=document.getElementById('verifyUrl').value.trim()||null;
    if(!name){alert('Name required');return;}
    let image_url=urlInput||null;
    if(file){
      const id=crypto.randomUUID();
      const ext=(file.name.split('.').pop()||'jpg').toLowerCase();
      const path=`submissions/${id}.${ext}`;
      const {error:upErr}=await supabase.storage.from('facecard').upload(path,file);
      if(upErr){alert('Upload failed');return;}
      const {data:pub}=supabase.storage.from('facecard').getPublicUrl(path);
      image_url=pub.publicUrl;
    }
    if(!image_url){alert('Need image');return;}
    const submission={display_name:name,image_url,x_handle:xHandle,verify_url:verifyUrl};
    const {error}=await supabase.from('submissions').insert(submission);
    if(error){alert('Submit failed');return;}
    location.hash='#/browse';
  }

  async function vote(id,direction){
    await fetch(EDGE_FUNCTION_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({submission_id:id,direction})});
    if(location.hash.startsWith('#/hall')) renderHall(); else renderBrowse();
  }
  </script>
</body>
</html>
